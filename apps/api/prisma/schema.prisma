generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  PHARMACIST
  INVENTORY_MANAGER
  SALES_CLERK
}

enum OrganizationType {
  RETAIL_PHARMACY
  HOSPITAL
}

enum AIActionType {
  REORDER_STOCK
  ADJUST_PRICE
  SEND_NOTIFICATION
  FLAG_EXPIRY
  ANALYZE_SALES
}

enum AIActionStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
  FAILED
}

model Organization {
  id            String           @id @default(uuid()) @db.Uuid
  name          String
  type          OrganizationType @default(RETAIL_PHARMACY)
  address       String?
  phone         String?
  email         String?
  website       String?
  licenseNumber String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @default(now()) @updatedAt

  departments   Department[]
  users         User[]
  suppliers     Supplier[]
  products      Product[]
  inventories   Inventory[]
  sales         Sale[]
  inventoryReturns InventoryReturn[]
  aiActionLogs  AIActionLog[]
}

model Department {
  id               String       @id @default(uuid()) @db.Uuid
  name             String
  organizationId   String       @db.Uuid
  headOfDepartment String?
  phoneNumber      String?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @default(now()) @updatedAt

  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users            User[]
  inventories      Inventory[]
}

model User {
  id             String       @id @default(uuid()) @db.Uuid
  email          String       @unique
  passwordHash   String
  firstName      String
  lastName       String
  role           Role         @default(PHARMACIST)
  phoneNumber    String?
  organizationId String       @db.Uuid
  departmentId   String?      @db.Uuid
  isActive       Boolean      @default(true)
  lastLogin      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department     Department?  @relation(fields: [departmentId], references: [id])
  sales          Sale[]
  processedReturns InventoryReturn[]
  aiActions      AIActionLog[]
}

model Supplier {
  id             String       @id @default(uuid()) @db.Uuid
  name           String
  contactPerson  String?
  email          String?
  phoneNumber    String?
  address        String?
  organizationId String       @db.Uuid
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventories    Inventory[]
  returns        InventoryReturn[]
}

model Product {
  id             String       @id @default(uuid()) @db.Uuid
  name           String
  genericName    String?
  description    String?
  manufacturer   String?
  barcode        String?
  sku            String?
  category       String?
  unit           String       @default("pcs")
  organizationId String       @db.Uuid
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  inventories    Inventory[]
}

model Inventory {
  id                String       @id @default(uuid()) @db.Uuid
  productId         String       @db.Uuid
  batchNumber       String?
  expiryDate        DateTime?
  quantity          Int          @default(0)
  costPrice         Decimal      @db.Decimal(10, 2)
  sellingPrice      Decimal      @db.Decimal(10, 2)
  location          String?
  supplierId        String?      @db.Uuid
  organizationId    String       @db.Uuid
  departmentId      String?      @db.Uuid
  lowStockThreshold Int?         @default(10)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @default(now()) @updatedAt

  product           Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  supplier          Supplier?    @relation(fields: [supplierId], references: [id])
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department        Department?  @relation(fields: [departmentId], references: [id])
  saleItems         SaleItem[]
  returnItems       InventoryReturnItem[]

  @@index([productId])
  @@index([expiryDate])
}

model Sale {
  id             String       @id @default(uuid()) @db.Uuid
  receiptNumber  String       @unique
  totalAmount    Decimal      @db.Decimal(10, 2)
  paymentMethod  String
  status         String       @default("COMPLETED")
  userId         String       @db.Uuid
  organizationId String       @db.Uuid
  patientId      String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  user           User         @relation(fields: [userId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  items          SaleItem[]

  @@index([organizationId])
  @@index([createdAt])
}

model SaleItem {
  id          String    @id @default(uuid()) @db.Uuid
  saleId      String    @db.Uuid
  inventoryId String    @db.Uuid
  quantity    Int
  unitPrice   Decimal   @db.Decimal(10, 2)
  subtotal    Decimal   @db.Decimal(10, 2)
  createdAt   DateTime  @default(now())

  sale        Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)
  inventory   Inventory @relation(fields: [inventoryId], references: [id])
}

model InventoryReturn {
  id             String       @id @default(uuid()) @db.Uuid
  returnNumber   String       @unique
  supplierId     String?      @db.Uuid
  organizationId String       @db.Uuid
  status         String       @default("PENDING")
  reason         String?
  processedBy    String?      @db.Uuid
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt

  supplier       Supplier?    @relation(fields: [supplierId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  processor      User?        @relation(fields: [processedBy], references: [id])
  items          InventoryReturnItem[]
}

model InventoryReturnItem {
  id          String          @id @default(uuid()) @db.Uuid
  returnId    String          @db.Uuid
  inventoryId String          @db.Uuid
  quantity    Int
  reason      String?
  createdAt   DateTime        @default(now())

  return      InventoryReturn @relation(fields: [returnId], references: [id], onDelete: Cascade)
  inventory   Inventory       @relation(fields: [inventoryId], references: [id])
}

model AIActionLog {
  id              String         @id @default(uuid()) @db.Uuid
  actionType      AIActionType
  description     String
  status          AIActionStatus @default(PENDING)
  confidenceScore Decimal?       @db.Decimal(5, 4)
  metadata        Json?
  userId          String?        @db.Uuid
  organizationId  String         @db.Uuid
  createdAt       DateTime       @default(now())
  executedAt      DateTime?

  user            User?          @relation(fields: [userId], references: [id])
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([status])
}
